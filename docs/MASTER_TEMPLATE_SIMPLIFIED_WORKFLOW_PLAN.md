# Master Template Simplified Workflow - Implementation Plan

## ðŸ“‹ Executive Summary

This plan outlines the implementation of a simplified workflow where:
1. **GUI auto-populates** "Inputs & Assumptions" sheet (already works âœ…)
2. **Master template** contains all required sheets with empty input/output cells for analysis modules
3. **Users manually fill** input cells in analysis sheets
4. **Users run Python scripts** from Terminal to execute analysis
5. **Python scripts** read inputs and write outputs directly to Excel cells

**No Excel buttons or VBA required** - pure Python scripts executed from Terminal.

### ðŸ“Š Chart Integration

**NEW:** This plan includes comprehensive chart generation for:
- **Presentation Sheets** (Inputs & Assumptions, Valuation Schedule, Summary & Results):
  - Generated automatically by GUI during Excel export
  - Professional charts for investor committee presentations
  - Includes: Assumptions summary, price/volume projections, cash flow waterfalls, risk breakdowns
  
- **Analysis Sheets** (Deal Valuation, Monte Carlo, Sensitivity, Breakeven):
  - Generated by Python scripts when analysis runs
  - Visual data representation for each analysis module
  - Includes: Histograms, heatmaps, scatter plots, breakeven visualizations

All charts are embedded directly in Excel sheets for seamless presentation and analysis.

---

## ðŸŽ¯ Current State Analysis

### âœ… What Already Works

1. **GUI Application** (`gui/carbon_model_gui.py`)
   - Uploads data files (Excel, Word, PDF)
   - Extracts assumptions automatically
   - Auto-populates "Inputs & Assumptions" sheet
   - Uses `template_based_export.py` to create Excel from master template

2. **Template-Based Export** (`export/template_based_export.py`)
   - Copies master template
   - Populates standard sheets (Inputs, Valuation, Summary)
   - Preserves interactive sheets

3. **Python Runner Scripts** (in `scripts/`)
   - `run_deal_valuation_from_excel.py` âœ…
   - `run_sensitivity_from_excel.py` âœ…
   - `run_monte_carlo_from_excel.py` âœ…
   - `run_breakeven_from_excel.py` âœ…
   - All scripts can read from Excel and write back

4. **Interactive Sheet Creators** (in `export/`)
   - `deal_valuation_interactive.py` âœ…
   - `sensitivity_interactive.py` âœ…
   - `monte_carlo_interactive.py` âœ…
   - `breakeven_interactive.py` âœ…

### âš ï¸ What Needs to Change

1. **Master Template Structure**
   - Currently has "Deal Valuation Interactive", "Sensitivity Interactive", etc.
   - Need to rename to: "Deal Valuation", "Sensitivity Analysis", "Monte Carlo Results", "Breakeven Analysis"
   - Need to ensure input/output cells are clearly defined and empty

2. **Sheet Naming Consistency**
   - Python scripts currently read from "Deal Valuation Interactive"
   - Need to update scripts to read from "Deal Valuation" (or make configurable)

3. **Template Creation**
   - `templates/create_master_template.py` needs updating
   - Should create sheets with proper names and empty input/output cells

4. **Documentation**
   - Need simple Terminal command guide for users

---

## ðŸ“Š Required Master Template Structure

### Sheet List (in order)

1. **Inputs & Assumptions**
   - Auto-populated by GUI âœ…
   - Contains: WACC, Investment Total, Tenor, Streaming %, Price Growth, Volume assumptions
   - **CHARTS** (auto-generated by GUI):
     - Key Assumptions Summary Chart (pie/bar chart showing investment breakdown)
     - Price Growth Projection Chart (line chart showing price forecast over 20 years)
     - Volume Projection Chart (line chart showing credit volume forecast)

2. **Valuation Schedule**
   - Auto-populated by GUI âœ…
   - 20-year cash flow table with formulas
   - **CHARTS** (auto-generated by GUI):
     - Cash Flow Waterfall Chart (stacked bar showing annual cash flows)
     - Cumulative Cash Flow Chart (line chart showing cumulative position over time)
     - NPV Trend Chart (line chart showing NPV progression)

3. **Summary & Results**
   - Auto-populated by GUI âœ…
   - Key metrics: NPV, IRR, Payback, Risk Flags, Risk Score
   - **CHARTS** (auto-generated by GUI):
     - Financial Metrics Dashboard (sparklines or mini charts for key metrics)
     - Risk Score Breakdown Chart (pie/bar chart showing risk components)
     - Investment Return Summary (bar chart comparing Target vs Actual IRR)

4. **Analysis** (blank separator tab)
   - Empty sheet for visual separation

5. **Deal Valuation**
   - **INPUT CELLS** (empty, user fills):
     - Target IRR (e.g., B8)
     - Streaming Percentage (e.g., B9)
     - Purchase Price (e.g., B10)
     - Investment Tenor (e.g., B11)
     - Calculation Type (e.g., B13)
   - **OUTPUT CELLS** (empty, Python populates):
     - Maximum Purchase Price (B22)
     - Actual IRR Achieved (B23)
     - Target IRR (B24)
     - Difference (B25)
     - NPV at Calculated Price (B26)
     - Required Streaming % (B27)
     - Project IRR (B28)
     - Status (B30)
   - **CHARTS** (generated by Python script):
     - Purchase Price vs IRR Chart (scatter/line showing relationship)
     - Sensitivity to Purchase Price Chart (bar chart showing how IRR changes with price)

6. **Monte Carlo Results**
   - **INPUT CELLS** (empty, user fills):
     - Number of Simulations (e.g., B8)
     - Use GBM? (e.g., B9)
     - GBM Drift (e.g., B10)
     - GBM Volatility (e.g., B11)
     - Volume Volatility (e.g., B12)
   - **OUTPUT CELLS** (empty, Python populates):
     - Mean IRR (B15)
     - P10/P50/P90 IRR (B16-B18)
     - Mean NPV (B20)
     - P10/P50/P90 NPV (B21-B23)
     - Probabilities (B25-B30)
   - **CHARTS** (generated by Python script):
     - IRR Distribution Histogram (with mean, P10, P50, P90 lines)
     - NPV Distribution Histogram (with mean, P10, P50, P90 lines)
     - Probability Distribution Chart (showing probability of achieving target IRR/NPV)

7. **Sensitivity Analysis**
   - **INPUT CELLS** (empty, user fills):
     - Credit Multiplier Range (e.g., B8-B9: min, max)
     - Price Multiplier Range (e.g., B10-B11: min, max)
     - Streaming Percentage (e.g., B12)
   - **OUTPUT CELLS** (empty, Python populates):
     - 2D Sensitivity Table (starting at B15)
     - Summary Statistics (B30-B35)
   - **CHARTS** (generated by Python script):
     - Sensitivity Heatmap (color-coded 2D heatmap showing IRR across credit/price ranges)
     - Tornado Chart (showing impact of each variable on IRR)
     - 3D Surface Chart (optional, showing IRR as function of credit and price)

8. **Breakeven Analysis**
   - **INPUT CELLS** (empty, user fills):
     - Metric to Calculate (e.g., B8: "price", "volume", "streaming", "all")
     - Target NPV (e.g., B9)
     - Streaming Percentage (e.g., B10)
   - **OUTPUT CELLS** (empty, Python populates):
     - Breakeven Price (B15)
     - Breakeven Volume (B16)
     - Breakeven Streaming % (B17)
   - **CHARTS** (generated by Python script):
     - Breakeven Analysis Chart (showing breakeven points for price, volume, streaming)
     - Breakeven Sensitivity Chart (showing how breakeven changes with assumptions)

---

## ðŸ”§ Implementation Steps

### Phase 1: Update Master Template Structure

#### Step 1.1: Update Interactive Sheet Creators
**Files to modify:**
- `export/deal_valuation_interactive.py`
- `export/sensitivity_interactive.py`
- `export/monte_carlo_interactive.py`
- `export/breakeven_interactive.py`

**Changes:**
- Change default sheet names from "X Interactive" to "X" (e.g., "Deal Valuation Interactive" â†’ "Deal Valuation")
- Ensure input cells are **empty** (not pre-filled with defaults)
- Ensure output cells are **empty**
- Add clear labels: "INPUT VARIABLES" and "OUTPUT RESULTS"
- Add placeholder areas for charts (reserve space, e.g., columns E-H for chart placement)

#### Step 1.2: Create Chart Generation Functions for Presentation Sheets
**New file:** `export/presentation_charts.py`

**Functions to create:**
- `create_assumptions_summary_chart()` - Pie/bar chart for Inputs & Assumptions
- `create_price_projection_chart()` - Line chart for price forecast
- `create_volume_projection_chart()` - Line chart for volume forecast
- `create_cash_flow_waterfall()` - Stacked bar for Valuation Schedule
- `create_cumulative_cash_flow()` - Line chart for cumulative position
- `create_npv_trend()` - Line chart for NPV progression
- `create_metrics_dashboard()` - Sparklines/mini charts for Summary
- `create_risk_breakdown()` - Pie/bar chart for risk components
- `create_return_summary()` - Bar chart comparing Target vs Actual IRR

**Chart placement:**
- Inputs & Assumptions: Charts in columns E-G (right side of sheet)
- Valuation Schedule: Charts below data table (starting row 25)
- Summary & Results: Charts in dedicated section (rows 30-60)

#### Step 1.3: Update Template Creator
**File:** `templates/create_master_template.py`

**Changes:**
- Create all 8 sheets in correct order
- Use updated interactive sheet creators (with new names)
- Ensure all input/output cells are empty
- Add "Analysis" separator sheet
- Reserve space for charts in presentation sheets (Inputs, Valuation, Summary)

#### Step 1.4: Update Template-Based Exporter
**File:** `export/template_based_export.py`

**Changes:**
- Update sheet name references to match new names
- Ensure it doesn't overwrite input cells in analysis sheets
- Only populate standard sheets (Inputs, Valuation, Summary)
- **NEW:** Generate and embed charts for presentation sheets using `presentation_charts.py`
- Charts should be embedded using `xlsxwriter` `insert_image()` or `add_chart()` methods

### Phase 2: Update Python Runner Scripts

#### Step 2.1: Update Sheet Name References
**Files to modify:**
- `scripts/run_deal_valuation_from_excel.py`
- `scripts/run_sensitivity_from_excel.py`
- `scripts/run_monte_carlo_from_excel.py`
- `scripts/run_breakeven_from_excel.py`

**Changes:**
- Change default `sheet_name` parameter from "X Interactive" to "X"
- Update cell references if needed (verify they match template)
- Add better error messages if sheet not found

#### Step 2.2: Add Chart Generation to Analysis Scripts
**Files to modify:**
- `scripts/run_deal_valuation_from_excel.py`
- `scripts/run_sensitivity_from_excel.py`
- `scripts/run_monte_carlo_from_excel.py` (already has charts âœ…)
- `scripts/run_breakeven_from_excel.py`

**New functionality:**
- **Deal Valuation:** Generate Purchase Price vs IRR chart, embed at cell E15
- **Sensitivity Analysis:** Generate heatmap chart (already exists âœ…), embed at cell E20
- **Monte Carlo:** Already generates histograms âœ…, ensure they're embedded at E27 and E35
- **Breakeven:** Generate breakeven analysis chart, embed at cell E20

**Chart embedding method:**
- Use `openpyxl` to add images to Excel sheets
- Save charts as temporary PNG files
- Use `openpyxl.drawing.image.Image()` to embed
- Place charts in reserved areas (columns E-H or below data)

#### Step 2.3: Create Chart Generation Module for Analysis Sheets
**New file:** `export/analysis_charts.py`

**Functions to create:**
- `create_deal_valuation_chart()` - Purchase Price vs IRR relationship
- `create_breakeven_chart()` - Breakeven points visualization
- `create_sensitivity_heatmap()` - Already exists in `excel_integration/chart_generator.py` âœ…
- `create_monte_carlo_histograms()` - Already exists in `excel_integration/chart_generator.py` âœ…

**Integration:**
- Update existing `excel_integration/chart_generator.py` to use `openpyxl` for embedding (not just xlwings)
- Add function to embed charts using `openpyxl` (works without xlwings)

#### Step 2.4: Verify Cell Mapping
**Action:**
- Test each script to ensure it reads from correct input cells
- Test each script to ensure it writes to correct output cells
- Test chart generation and embedding for each module
- Document cell mappings and chart locations in each script's docstring

### Phase 3: Testing & Validation

#### Step 3.1: Create Test Workflow
1. Run GUI with test data
2. Verify "Inputs & Assumptions" is populated
3. Open Excel, verify all sheets exist
4. Fill input cells in one analysis sheet (e.g., Deal Valuation)
5. Run Python script from Terminal
6. Verify outputs populate correctly

#### Step 3.2: Test All Four Modules
- Deal Valuation Back-Solver
- Monte Carlo Simulation
- Sensitivity Analysis
- Breakeven Calculator

### Phase 4: Documentation

#### Step 4.1: Create User Guide
**File:** `docs/SIMPLIFIED_WORKFLOW_USER_GUIDE.md`

**Contents:**
- Overview of workflow
- How to use GUI to create Excel file
- How to fill input cells in analysis sheets
- Terminal commands for each module
- Example outputs

#### Step 4.2: Update README
**File:** `README.md`

**Changes:**
- Add section on "Simplified Workflow"
- Update sheet list to reflect new structure
- Add Terminal command examples

---

## ðŸ“ Detailed Cell Mappings

### Deal Valuation Sheet

**Input Cells:**
- B8: Target IRR (decimal, e.g., 0.20)
- B9: Streaming Percentage (decimal, e.g., 0.48)
- B10: Purchase Price (number, e.g., 20000000)
- B11: Investment Tenor (integer, e.g., 5)
- B13: Calculation Type (string: "Solve for Purchase Price", "Calculate IRR from Price", "Solve for Streaming %")

**Output Cells:**
- B22: Maximum Purchase Price
- B23: Actual IRR Achieved
- B24: Target IRR
- B25: Difference
- B26: NPV at Calculated Price
- B27: Required Streaming %
- B28: Project IRR
- B30: Status

**Terminal Command:**
```bash
python3 scripts/run_deal_valuation_from_excel.py "path/to/excel_file.xlsx"
```

### Monte Carlo Results Sheet

**Input Cells:**
- B8: Number of Simulations (integer, e.g., 5000)
- B9: Use GBM? (boolean/string: "Yes"/"No" or TRUE/FALSE)
- B10: GBM Drift (decimal, e.g., 0.03)
- B11: GBM Volatility (decimal, e.g., 0.15)
- B12: Volume Volatility (decimal, e.g., 0.15)

**Output Cells:**
- B15: Mean IRR
- B16: P10 IRR
- B17: P50 IRR
- B18: P90 IRR
- B20: Mean NPV
- B21: P10 NPV
- B22: P50 NPV
- B23: P90 NPV
- B25-B30: Probabilities (IRR > 20%, NPV > 0, etc.)

**Terminal Command:**
```bash
python3 scripts/run_monte_carlo_from_excel.py "path/to/excel_file.xlsx"
```

### Sensitivity Analysis Sheet

**Input Cells:**
- B8: Credit Multiplier Min (decimal, e.g., 0.5)
- B9: Credit Multiplier Max (decimal, e.g., 1.5)
- B10: Price Multiplier Min (decimal, e.g., 0.5)
- B11: Price Multiplier Max (decimal, e.g., 1.5)
- B12: Streaming Percentage (decimal, e.g., 0.48)

**Output Cells:**
- B15: Start of 2D Sensitivity Table (IRR values)
- B30-B35: Summary Statistics (Min, Max, Range, etc.)

**Terminal Command:**
```bash
python3 scripts/run_sensitivity_from_excel.py "path/to/excel_file.xlsx"
```

### Breakeven Analysis Sheet

**Input Cells:**
- B8: Metric to Calculate (string: "price", "volume", "streaming", "all")
- B9: Target NPV (number, e.g., 0)
- B10: Streaming Percentage (decimal, e.g., 0.48)

**Output Cells:**
- B15: Breakeven Price
- B16: Breakeven Volume
- B17: Breakeven Streaming %

**Terminal Command:**
```bash
python3 scripts/run_breakeven_from_excel.py "path/to/excel_file.xlsx"
```

---

## âœ… Success Criteria

1. âœ… Master template has all 8 sheets in correct order
2. âœ… All analysis sheets have clearly labeled input/output sections
3. âœ… Input cells are empty (ready for user input)
4. âœ… Output cells are empty (ready for Python to populate)
5. âœ… Python scripts read from correct input cells
6. âœ… Python scripts write to correct output cells
7. âœ… GUI auto-populates "Inputs & Assumptions" correctly
8. âœ… **NEW:** GUI generates and embeds charts in presentation sheets (Inputs, Valuation, Summary)
9. âœ… **NEW:** Python scripts generate and embed charts in analysis sheets (Deal Valuation, Monte Carlo, Sensitivity, Breakeven)
10. âœ… Terminal commands work for all 4 modules
11. âœ… Documentation is clear and complete

---

## ðŸš€ Implementation Order

1. **Create chart generation modules**
   - `export/presentation_charts.py` (for GUI-generated charts)
   - Update `export/analysis_charts.py` or `excel_integration/chart_generator.py` (for Python script charts)

2. **Update interactive sheet creators** (rename sheets, empty cells, reserve chart space)

3. **Update template creator** (use new sheet names, create all 8 sheets, reserve chart areas)

4. **Update template-based exporter** (add chart generation for presentation sheets)

5. **Update Python scripts** (change sheet name references, add chart generation)

6. **Test end-to-end workflow** (GUI â†’ Excel â†’ Terminal â†’ Results + Charts)

7. **Create documentation** (user guide, README update, chart descriptions)

---

## ðŸ“Œ Notes

- **No VBA or Excel buttons needed** - pure Python scripts
- **Input cells must be empty** in template (users fill manually)
- **Output cells must be empty** in template (Python populates)
- **GUI only populates** "Inputs & Assumptions", "Valuation Schedule", "Summary & Results"
- **Analysis sheets remain untouched** by GUI (preserved for user input)

---

## ðŸ“Š Chart Specifications

### Presentation Sheets (Generated by GUI)

#### Inputs & Assumptions Sheet
**Chart 1: Key Assumptions Summary**
- Type: Pie or Horizontal Bar Chart
- Data: Investment Total, WACC, Tenor, Streaming %
- Location: E2-G15
- Purpose: Visual summary of key deal parameters

**Chart 2: Price Growth Projection**
- Type: Line Chart
- Data: 20-year price forecast from assumptions
- Location: E17-G32
- Purpose: Show price trajectory over investment period

**Chart 3: Volume Projection**
- Type: Line Chart
- Data: 20-year credit volume forecast
- Location: E34-G49
- Purpose: Show volume trajectory over investment period

#### Valuation Schedule Sheet
**Chart 1: Cash Flow Waterfall**
- Type: Stacked Bar Chart
- Data: Annual cash flows (positive/negative)
- Location: Below data table (row 25, columns A-G)
- Purpose: Visualize annual cash flow composition

**Chart 2: Cumulative Cash Flow**
- Type: Line Chart
- Data: Cumulative cash flow over 20 years
- Location: Row 25, columns I-M
- Purpose: Show cumulative position over time

**Chart 3: NPV Trend**
- Type: Line Chart
- Data: NPV progression over time
- Location: Row 45, columns A-G
- Purpose: Show NPV build-up over investment period

#### Summary & Results Sheet
**Chart 1: Financial Metrics Dashboard**
- Type: Sparklines or Mini Bar Charts
- Data: NPV, IRR, Payback Period
- Location: E5-G10
- Purpose: Quick visual summary of key metrics

**Chart 2: Risk Score Breakdown**
- Type: Pie or Bar Chart
- Data: Financial Risk, Volume Risk, Price Risk components
- Location: E15-G25
- Purpose: Visualize risk composition

**Chart 3: Investment Return Summary**
- Type: Bar Chart (Grouped)
- Data: Target IRR vs Actual IRR
- Location: E30-G40
- Purpose: Compare target vs achieved returns

### Analysis Sheets (Generated by Python Scripts)

#### Deal Valuation Sheet
**Chart 1: Purchase Price vs IRR**
- Type: Scatter or Line Chart
- Data: Multiple price points and corresponding IRRs
- Location: E15-G30
- Purpose: Show relationship between purchase price and IRR

**Chart 2: Sensitivity to Purchase Price**
- Type: Bar Chart
- Data: IRR at different purchase price points
- Location: E32-G45
- Purpose: Show how IRR changes with price variations

#### Monte Carlo Results Sheet
**Chart 1: IRR Distribution Histogram**
- Type: Histogram with Overlay Lines
- Data: IRR simulation results
- Location: E27-G42
- Purpose: Show IRR distribution with percentiles (P10, P50, P90, Mean)

**Chart 2: NPV Distribution Histogram**
- Type: Histogram with Overlay Lines
- Data: NPV simulation results
- Location: E35-G50
- Purpose: Show NPV distribution with percentiles

**Chart 3: Probability Distribution**
- Type: Bar Chart
- Data: Probabilities (IRR > 20%, NPV > 0, etc.)
- Location: E52-G60
- Purpose: Show probability of achieving targets

#### Sensitivity Analysis Sheet
**Chart 1: Sensitivity Heatmap**
- Type: 2D Heatmap (Color-coded)
- Data: IRR values across credit/price multiplier ranges
- Location: E20-G35
- Purpose: Visualize IRR sensitivity to credit and price changes

**Chart 2: Tornado Chart**
- Type: Horizontal Bar Chart
- Data: Impact of each variable on IRR
- Location: E37-G50
- Purpose: Show which variables have most impact

#### Breakeven Analysis Sheet
**Chart 1: Breakeven Points Visualization**
- Type: Bar or Scatter Chart
- Data: Breakeven price, volume, streaming %
- Location: E20-G35
- Purpose: Visualize all breakeven points together

**Chart 2: Breakeven Sensitivity**
- Type: Line Chart
- Data: How breakeven changes with different assumptions
- Location: E37-G50
- Purpose: Show sensitivity of breakeven points

### Chart Generation Requirements

**For Presentation Sheets (GUI):**
- Use `xlsxwriter` for chart creation (native Excel charts)
- Or use `matplotlib` + `openpyxl` for image embedding
- Charts should be generated during `template_based_export.py`
- Charts should update automatically when assumptions change

**For Analysis Sheets (Python Scripts):**
- Use `matplotlib` to generate charts as PNG images
- Use `openpyxl` to embed images into Excel sheets
- Charts should be generated when Python scripts run
- Charts should be placed in reserved areas (columns E-H)

**Chart Styling:**
- Professional color scheme (blues, greens, grays)
- Clear titles and axis labels
- Appropriate font sizes (readable in presentations)
- Consistent formatting across all charts

## ðŸ”„ Future Enhancements (Optional)

- Add validation for input cells (warn if empty when running script)
- Add progress indicators in status cells
- Add error handling with clear messages in status cells
- Create batch script to run all analyses at once
- Add option to save results to separate "Results Archive" sheet
- Add interactive charts (if Excel version supports)
- Add chart export functionality (save charts as separate images)
- Add chart customization options (colors, styles, etc.)

